---
title: "Example2: PBMC68K"
output:
  workflowr::wflow_html:
    toc: false
editor_options:
  chunk_output_type: console
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      comment = NA)
library(HIPPO)
library(SingleCellExperiment)
```

## Read the data

This data set is available in 10X [website](https://support.10xgenomics.com/single-cell-gene-expression/datasets/1.1.0/fresh_68k_pbmc_donor_a). The format is Matrix, so we need Matrix package for this particular example.

```{r}
library(Matrix)
X = readMM("/Volumes/tae/Work/SC/data/10X_68K/filtered_matrix/hg19/matrix.mtx")
rowdata =  read.table("/Volumes/tae/Work/SC/data/10X_68K/filtered_matrix/hg19/genes.tsv") # this shows both ENSG IDs and HGNC symbols
coldata = data.table::setDF(data.table::fread("/Volumes/tae/Work/SC/data/10X_68K/filtered_matrix/hg19/barocdes_annotation.tsv")) # this shows barcode information
rownames(X) = rowdata$V1
colnames(X) = coldata$barcodes
```

My local laptop cannot handle such a large matrix, so I will reduce the number of cells by random sampling.

```{r}
set.seed(20200117)
cells = sample(1:ncol(X), size = 3000)
X = X[, cells]
coldata = coldata[cells, ]
```

Then create the SingleCellExperiment object.

```{r}
sce = SingleCellExperiment(assays = list(counts = as.matrix(X)),
                           rowData = rowdata,
                           colData = coldata)

rm(X, rowdata, coldata); gc()
```

## Diagnostic Plot

```{r}
hippo_diagnostic_plot(sce)
```

## Feature Selection and Hierarchical Clustering

```{r}
set.seed(20191031)
sce = hippo(sce, K = 6, z_threshold = 1.5, outlier_proportion = 0.005)
```

## Dimension Reduction for Each Round of HIPPO

```{r,fig.width = 5, fig.height = 6}
sce = dimension_reduction(sce, method="umap")
hippo_umap_plot(sce)
```

```{r,fig.width = 6, fig.height = 6}
sce = dimension_reduction(sce, method="tsne")
hippo_tsne_plot(sce)
```

## Visualize the selected features at each round

```{r,fig.width = 6, fig.height = 6}
zero_proportion_plot(sce)
```

## Differential Expression Example

```{r, fig.width=6, fig.height=8}
ref = data.frame(hgnc = rowData(sce)$V2,
                 ensg = rowData(sce)$V1)
head(ref)
sce = diffexp(sce, top.n = 5, switch_to_hgnc = TRUE, ref = ref)
head(sce@int_metadata$hippo$diffexp$result_table[[1]]) #round 1: monocytes
head(sce@int_metadata$hippo$diffexp$result_table[[2]]) #round 2: B cells
head(sce@int_metadata$hippo$diffexp$result_table[[3]]) #round 3: regulatory T cells
```


## Session Info

```{r}
sessionInfo()
```
